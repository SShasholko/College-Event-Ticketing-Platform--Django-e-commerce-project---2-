<!-- ticket_purchase.html -->
{% extends 'events/base.html' %}

{% block title %}Purchase Tickets{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <h1>Purchase Tickets for {{ event.title }}</h1>
    <p>Price per Ticket: ${{ event.ticket_price }}</p>

    <!-- Quantity Selector -->
    <label for="quantity">Select Quantity:</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1" style="width: 100%; padding: 8px; margin-bottom: 15px;">

    <!-- Display Total Price -->
    <p>Total Price: $<span id="total_price">{{ event.ticket_price }}</span></p>

    <!-- Payment Form -->
    <form id="payment-form">
        {% csrf_token %}

        <!-- Billing Details -->
        <label for="name">Full Name:</label>
        <input type="text" id="name" name="name" value="{{ request.user.get_full_name }}" style="width: 100%; padding: 8px; margin-bottom: 15px;" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" value="{{ request.user.email }}" style="width: 100%; padding: 8px; margin-bottom: 15px;" required>

        <!-- Stripe Card Element -->
        <div id="card-element" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px;"></div>
        <div id="card-errors" role="alert" style="color: red; margin-bottom: 10px;"></div> <!-- Error display -->

        <!-- Purchase Button -->
        <button type="button" id="submit-button" style="width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">Purchase Ticket</button>
    </form>

    <a href="{% url 'event_detail' event.id %}">Back to Event Details</a>
</div>

<!-- Include Stripe JS library -->
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const stripe = Stripe("pk_test_51QABFFGariyyw43I1YaqstFbwppWvdVawZud6wrzfJ0OPdpm7sYkQxemEOaMadNml5s9QHisXkCD0MFMzrNy9TWM00LOGaJGxf");
    const elements = stripe.elements();

    // Set up Stripe card element styles
    const style = {
        base: {
            color: "#32325d",
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSize: "16px",
            "::placeholder": { color: "#aab7c4" }
        },
        invalid: { color: "#fa755a" }
    };

    const cardElement = elements.create("card", { style: style, hidePostalCode: true });
    cardElement.mount("#card-element");

    // Display errors for the card Element
    cardElement.on("change", function (event) {
        const displayError = document.getElementById("card-errors");
        displayError.textContent = event.error ? event.error.message : "";
    });

    // Update total price dynamically based on quantity input
    const quantityInput = document.getElementById("quantity");
    const totalPriceSpan = document.getElementById("total_price");
    const ticketPrice = {{ event.ticket_price|floatformat:2 }};
    quantityInput.addEventListener("input", function () {
        const quantity = parseInt(quantityInput.value) || 1;
        const totalPrice = (quantity * ticketPrice).toFixed(2);
        totalPriceSpan.textContent = totalPrice;
    });

    // Handle the purchase button click
    document.getElementById("submit-button").addEventListener("click", function (e) {
        e.preventDefault();
        
        const quantity = quantityInput.value;
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;

        fetch("{% url 'create_payment_intent' event.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ quantity: quantity })
        })
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            if (data.error) {
                document.getElementById("card-errors").textContent = data.error;
            } else {
                stripe.confirmCardPayment(data.client_secret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: { name: document.getElementById("name").value, email: document.getElementById("email").value }
                    }
                }).then(function (result) {
                    if (result.error) {
                        document.getElementById("card-errors").textContent = result.error.message;
                    } else {
                        window.location.href = "{% url 'success' %}";
                    }
                });
            }
        })
        .catch(error => {
            console.error("Payment initiation failed:", error);
            document.getElementById("card-errors").textContent = "Failed to initiate payment. Please try again.";
        });
    });
});
</script>

{% endblock %}
